name: Build Godot Web Game

on:
  repository_dispatch:
    types: [build_game]

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Resolve inputs
        run: |
          echo "GAME_ID=${{ github.event.client_payload.game_id }}" >> $GITHUB_ENV
          echo "TEMPLATE=${{ github.event.client_payload.template }}" >> $GITHUB_ENV

      - name: Show paths
        run: |
          echo "Workspace:"
          pwd
          echo "Games:"
          ls games
          echo "Template:"
          ls games/${TEMPLATE}

      - name: Build Docker image
        run: docker build -t godot .

      - name: Prepare build directory
        run: |
          mkdir -p builds/${GAME_ID}
          ls builds

      - name: Export Web build
        run: |
          docker run --rm \
            -v "${GITHUB_WORKSPACE}:/project" \
            godot \
            --headless \
            --path /project/games/${TEMPLATE} \
            --export-release "Web" /project/builds/${GAME_ID}/index.html

      - name: Verify output
        run: |
          ls -la builds/${GAME_ID}
          test -f builds/${GAME_ID}/index.html

      - name: Commit build
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add builds/${GAME_ID}
          git commit -m "Build ${GAME_ID}" || echo "Nothing to commit"
          git push
