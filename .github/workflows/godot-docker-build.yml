name: Build Godot Web Game (fixed YAML)

on:
  workflow_dispatch:
    inputs:
      game_name:
        description: "Output build folder name"
        required: true
        default: "runner"
      template:
        description: "Game template folder inside /games"
        required: true
        default: "runner"

  repository_dispatch:
    types: [build_game]

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Resolve GAME_NAME and TEMPLATE
        id: resolve
        run: |
          python3 - <<'PY'
          import json, os
          evpath = os.environ.get("GITHUB_EVENT_PATH", "/github/workflow/event.json")
          ev = {}
          try:
              ev = json.load(open(evpath))
except Exception:
    ev = {}
          payload = ev.get("client_payload", {}) or {}
          game = payload.get("game_name") or payload.get("game_id") or (ev.get("inputs") or {}).get("game_name") or os.environ.get("INPUT_GAME_NAME") or "runner"
          template = payload.get("template") or (ev.get("inputs") or {}).get("template") or os.environ.get("INPUT_TEMPLATE") or "runner"
          game = str(game)
          template = str(template)
          print("Resolved GAME_NAME=" + game)
          print("Resolved TEMPLATE=" + template)
with open(os.environ['GITHUB_ENV'], 'a') as fh:
    fh.write(f"GAME_NAME={game}\n")
    fh.write(f"TEMPLATE={template}\n")
PY

     - name: Install system dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y wget unzip zip python3 libglu1-mesa libfontconfig1

      - name: Download & install Godot
        run: |
          set -e
          VER=4.2.1-stable
          ZIP="Godot_v${VER}_linux.headless.64.zip"
          URL="https://github.com/godotengine/godot/releases/download/${VER}/${ZIP}"
          mkdir -p /tmp/godot_dl
          cd /tmp/godot_dl
          if wget -q --timeout=30 "$URL" -O "$ZIP"; then
            unzip -q "$ZIP" -d /tmp/godot_unzip || true
          else
            # fallback to non-headless build
            ZIP2="Godot_v${VER}_linux.x86_64.zip"
            URL2="https://github.com/godotengine/godot/releases/download/${VER}/${ZIP2}"
            wget -q --timeout=30 "$URL2" -O "$ZIP2"
            unzip -q "$ZIP2" -d /tmp/godot_unzip || true
          fi
          BIN=$(find /tmp/godot_unzip -type f -perm /111 -name "Godot*" -print -quit || true)
          if [ -z "$BIN" ]; then
            BIN=$(find /tmp/godot_unzip -type f -name "Godot*" -print -quit || true)
          fi
          if [ -z "$BIN" ]; then
            echo "Could not find Godot binary" >&2
            ls -la /tmp/godot_unzip || true
            exit 11
          fi
          chmod +x "$BIN" || true
          sudo mv "$BIN" /usr/local/bin/godot || sudo cp "$BIN" /usr/local/bin/godot
          echo "Godot installed at $(which godot || echo /usr/local/bin/godot)"
          godot --version || true

      - name: Install Godot export templates
        run: |
          set -e
          export XDG_DATA_HOME="${HOME}/.local/share"
          mkdir -p "$XDG_DATA_HOME/godot"
          TPL="Godot_v4.2.1-stable_export_templates.tpz"
          TPL_URL="https://github.com/godotengine/godot/releases/download/4.2.1-stable/${TPL}"
          cd /tmp
          wget -q --timeout=30 "$TPL_URL" -O "$TPL"
          unzip -q "$TPL" -d "$XDG_DATA_HOME/godot" || true
          if [ -d "$XDG_DATA_HOME/godot/templates" ]; then
            mv "$XDG_DATA_HOME/godot/templates/"* "$XDG_DATA_HOME/godot/" || true
            rm -rf "$XDG_DATA_HOME/godot/templates" || true
          fi
          rm -f /tmp/$TPL || true
          echo "Templates installed to $XDG_DATA_HOME/godot"
          ls -la "$XDG_DATA_HOME/godot" || true

      - name: Prepare workspace (copy template)
        run: |
          set -e
          echo "Using template: $TEMPLATE ; game_name: $GAME_NAME"
          rm -rf build_work out_builds || true
          mkdir -p build_work out_builds
          if [ ! -d "games/$TEMPLATE" ]; then
            echo "Template games/$TEMPLATE not found. Available:" >&2
            ls -1 games || true
            exit 13
          fi
          cp -r "games/$TEMPLATE/." build_work/
          echo "build_work contents:"
          ls -la build_work || true

      - name: Patch export_presets.cfg (ensure required keys)
        run: |
          PRE="build_work/export_presets.cfg"
          if [ -f "$PRE" ]; then
            python3 - <<'PY'
from pathlib import Path
import re
p = Path("build_work/export_presets.cfg")
s = p.read_text(encoding="utf-8")
m = re.search(r'(\[preset\.0\]\s*)(.*?)(?=\n\[preset\.|\Z)', s, flags=re.S)
if m:
    block = m.group(2)
    changed = False
    if 'export_filter' not in block:
        block += '\nexport_filter="all_resources"'
        changed = True
    if 'include_filter' not in block:
        block += '\ninclude_filter=""'
        changed = True
    if 'exclude_filter' not in block:
        block += '\nexclude_filter=""'
        changed = True
    if 'export_path' not in block or 'index.html' not in block:
        # set export_path to build/index.html inside the workspace (Godot CLI will override when needed)
        if 'export_path' in block:
            block = re.sub(r'export_path\s*=\s*".*?"', 'export_path="build/index.html"', block)
        else:
            block += '\nexport_path="build/index.html"'
        changed = True
    if changed:
        new = s[:m.start(2)] + block + s[m.end(2):]
        p.write_text(new, encoding="utf-8")
        print("Patched export_presets.cfg (preset.0)")
    else:
        print("export_presets.cfg preset.0 already OK")
else:
    print("No [preset.0] found - skipping patch")
PY
          else
            echo "No export_presets.cfg found in template - continuing" || true
          fi
          echo "After patch (first 200 lines):"
          sed -n '1,200p' build_work/export_presets.cfg || true

      - name: Export to out_builds/$GAME_NAME
        run: |
          set -o pipefail
          mkdir -p out_builds/$GAME_NAME
          echo "Exporting to out_builds/$GAME_NAME ..."
          godot --headless --path build_work --export "Web" out_builds/$GAME_NAME 2>&1 | tee godot_export_log.txt || true
          echo "==== tail of godot_export_log.txt ===="
          tail -n 200 godot_export_log.txt || true
          ls -la out_builds/$GAME_NAME || true

      - name: Fallback: try export-release if necessary
        run: |
          if [ -f "out_builds/$GAME_NAME/index.html" ]; then
            echo "index.html exists, skipping fallback."
            exit 0
          fi
          echo "Trying export-release fallback..."
          godot --headless --path build_work --export-release "Web" out_builds/$GAME_NAME 2>&1 | tee -a godot_export_log.txt || true
          echo "==== tail of godot_export_log.txt (after fallback) ===="
          tail -n 200 godot_export_log.txt || true
          ls -la out_builds/$GAME_NAME || true
          if [ ! -f "out_builds/$GAME_NAME/index.html" ]; then
            echo "Export failed (no index.html)" >&2
            exit 20
          fi

      - name: Promote build -> builds/$GAME_NAME and commit
        run: |
          if [ ! -f "out_builds/$GAME_NAME/index.html" ]; then
            echo "No out build found to promote" >&2
            exit 21
          fi
          rm -rf "builds/$GAME_NAME" || true
          mkdir -p "builds/$GAME_NAME"
          cp -r out_builds/$GAME_NAME/* builds/$GAME_NAME/
          echo "Promoted contents:"
          ls -la builds/$GAME_NAME || true
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add builds || true
          git commit -m "CI: build web game ${GAME_NAME}" || echo "Nothing to commit"
          git push || echo "Push skipped or failed"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: godot-build-${{ env.GAME_NAME }}
          path: builds/${{ env.GAME_NAME }}
