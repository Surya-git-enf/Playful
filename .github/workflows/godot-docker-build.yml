name: Build Godot Web Game (Docker + Commit)

on:
  workflow_dispatch:
    inputs:
      game_name:
        description: "Output build folder name (e.g. game id or friendly name)"
        required: true
        default: "runner"
      template:
        description: "Template folder under games/ (e.g. runner)"
        required: true
        default: "runner"

  repository_dispatch:
    types: [build_game]

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    # Resolve defaults from workflow inputs or repository_dispatch client_payload
    env:
      GAME_NAME: ${{ github.event.inputs.game_name || github.event.client_payload.game_name || github.event.client_payload.game_id }}
      TEMPLATE:  ${{ github.event.inputs.template  || github.event.client_payload.template || 'runner' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Show repo root & useful info (debug)
        run: |
          echo "GITHUB_WORKSPACE: $GITHUB_WORKSPACE"
          echo "Resolved GAME_NAME=$GAME_NAME"
          echo "Resolved TEMPLATE=$TEMPLATE"
          pwd
          ls -la

      - name: Build Docker image (godot builder)
        run: |
          docker build -t godot-builder:latest -f Dockerfile .

      - name: Ensure builds folder exists
        run: mkdir -p builds/"$GAME_NAME"

      - name: Run Godot export inside container
        # run Godot inside the image; mount repo as /project so outputs are written back into workspace
        env:
          HOME: /root
        run: |
          echo "Exporting template: $TEMPLATE -> builds/$GAME_NAME"
          docker run --rm \
            -v "${{ github.workspace }}":/project \
            -w /project \
            godot-builder:latest \
            --headless --path /project/games/"$TEMPLATE" --export-release "Web" /project/builds/"$GAME_NAME"/index.html

      - name: Show build contents (verify)
        run: |
          echo "Listing builds/$GAME_NAME (if created):"
          ls -la builds/"$GAME_NAME" || echo "No build folder found"

      - name: Commit build files (if any)
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          if [ -d "builds/$GAME_NAME" ] && [ "$(ls -A builds/$GAME_NAME)" ]; then
            echo "Build found â€” committing builds/$GAME_NAME to repo"
            git add builds/"$GAME_NAME"
            git commit -m "Build game: $GAME_NAME" || echo "Nothing to commit (maybe same files)"
            # Push; rely on checkout action's persisted credentials (GITHUB_TOKEN)
            git push || echo "git push failed (check branch protection / permissions)"
          else
            echo "No build output to commit for builds/$GAME_NAME"
          fi

      - name: Upload build artifact (fallback)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: godot-build-${{ env.GAME_NAME }}
          path: builds/${{ env.GAME_NAME }}
