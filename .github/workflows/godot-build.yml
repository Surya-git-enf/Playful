name: Godot Docker Web Build

on:
  workflow_dispatch:
    inputs:
      game_name:
        description: "Output build folder name (manual)"
        required: true
        default: "runner"
      template:
        description: "Template folder inside games/"
        required: true
        default: "runner"
  repository_dispatch:
    types: [build_game]

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build godot Docker image (tag: godot)
        run: |
          docker build -f Dockerfile -t godot:latest .

      - name: Resolve variables (GAME_NAME & TEMPLATE)
        run: |
          # prefer repository_dispatch payload; fallback to workflow inputs
          if [ -n "${{ github.event.client_payload.game_id }}" ]; then
            echo "GAME_NAME=${{ github.event.client_payload.game_id }}" >> $GITHUB_ENV
          else
            echo "GAME_NAME=${{ github.event.inputs.game_name }}" >> $GITHUB_ENV
          fi

          if [ -n "${{ github.event.client_payload.template }}" ]; then
            echo "TEMPLATE=${{ github.event.client_payload.template }}" >> $GITHUB_ENV
          else
            echo "TEMPLATE=${{ github.event.inputs.template }}" >> $GITHUB_ENV
          fi

          echo "Resolved: GAME_NAME=$GAME_NAME TEMPLATE=$TEMPLATE"

      - name: Prepare workspace (copy project into build_work)
        run: |
          rm -rf build_work out_builds builds || true
          mkdir -p build_work out_builds builds
          if [ ! -d "games/$TEMPLATE" ]; then
            echo "Template 'games/$TEMPLATE' not found. Available templates:" >&2
            ls -1 games || true
            exit 1
          fi
          cp -r "games/$TEMPLATE/." build_work/
          echo "Copied games/$TEMPLATE -> build_work (listing):"
          ls -la build_work || true
          echo "export_presets.cfg (head):"
          sed -n '1,120p' build_work/export_presets.cfg || true

      - name: Run Godot export inside Docker (export to out_builds/$GAME_NAME)
        run: |
          mkdir -p out_builds/$GAME_NAME
          echo "Running container: exporting to out_builds/$GAME_NAME ..."
          docker run --rm \
            -v "$PWD":/project \
            godot:latest \
            --headless --path /project/build_work --export "Web" /project/out_builds/$GAME_NAME 2>&1 | tee godot_export_log.txt || true
          echo "==== tail of godot_export_log.txt ===="
          tail -n 200 godot_export_log.txt || true
          echo "Listing out_builds/$GAME_NAME:"
          ls -la out_builds/$GAME_NAME || true

      - name: Promote build into builds/$GAME_NAME if index.html exists
        run: |
          if [ -f out_builds/$GAME_NAME/index.html ]; then
            rm -rf builds/$GAME_NAME || true
            mkdir -p builds/$GAME_NAME
            cp -r out_builds/$GAME_NAME/* builds/$GAME_NAME/
            echo "Export success: builds/$GAME_NAME created (listing):"
            ls -la builds/$GAME_NAME || true
          else
            echo "ERROR: index.html not found in out_builds/$GAME_NAME"
            echo "Show godot_export_log.txt tail (300):"
            tail -n 300 godot_export_log.txt || true
            exit 2
          fi

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: godot-build-${{ env.GAME_NAME }}
          path: builds/${{ env.GAME_NAME }}
