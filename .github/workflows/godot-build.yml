name: Build Godot Web (triggered by repo dispatch)

on:
  repository_dispatch:
    types: [ build_game ]

jobs:
  build_web:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Parse payload (action input)
        id: payload
        run: |
          echo "payload=$GITHUB_EVENT_PATH"
          python3 - <<'PY'
import json,os
p = json.load(open(os.environ['GITHUB_EVENT_PATH']))
cp = p.get('client_payload', {})
print("::set-output name=GAME_ID::"+str(cp.get('game_id','')))
print("::set-output name=CALLBACK_URL::"+str(cp.get('callback_upload_url','')))
print("::set-output name=TEMPLATE::"+str(cp.get('template','')))
print("::set-output name=BUILD_TYPE::"+str(cp.get('build_type','')))
PY
        env:
          # GITHUB_EVENT_PATH is available automatically
          PYTHONUNBUFFERED: 1

      - name: Show parsed vars (for debug)
        run: |
          echo "Event payload file: $GITHUB_EVENT_PATH"
          jq '.' $GITHUB_EVENT_PATH || true

      - name: Download Godot headless (NON-MONO) - from secret URL
        env:
          GODOT_DOWNLOAD_URL: ${{ secrets.GODOT_DOWNLOAD_URL }}
        run: |
          if [ -z "$GODOT_DOWNLOAD_URL" ]; then
            echo "Set repository secret GODOT_DOWNLOAD_URL to a non-mono Godot headless linux zip URL"
            exit 1
          fi
          wget -q "$GODOT_DOWNLOAD_URL" -O godot.zip
          unzip -q godot.zip -d godot_bin
          # try to find binary
          ls -la godot_bin

      - name: Make Godot binary executable
        run: |
          # find the executable inside godot_bin (simple heuristic)
          BIN=$(find godot_bin -maxdepth 2 -type f -executable | head -n1 || true)
          if [ -z "$BIN" ]; then
            # try common filename patterns
            BIN=$(find godot_bin -type f -name "Godot_*" | head -n1 || true)
          fi
          if [ -z "$BIN" ]; then
            echo "Godot binary not found after unzip. Check GODOT_DOWNLOAD_URL and archive contents."
            ls -la godot_bin
            exit 1
          fi
          echo "Using godot binary: $BIN"
          chmod +x "$BIN"
          echo "::set-output name=GODOT_BIN::$BIN"

      - name: Prepare config (inject client payload)
        run: |
          python3 - <<'PY'
import json,os
ev = json.load(open(os.environ['GITHUB_EVENT_PATH']))
cp = ev.get('client_payload', {})
game_id = cp.get('game_id','game_unknown')
# save payload for inspection / can be used to write config.json into project
os.makedirs('build_meta', exist_ok=True)
with open('build_meta/payload.json','w') as f:
    json.dump(cp, f)
print("Saved payload for game:",game_id)
PY

      - name: Ensure export_presets.cfg exists
        run: |
          if [ ! -f export_presets.cfg ]; then
            echo "export_presets.cfg not found in repo root. Godot CLI export relies on a preset named 'HTML5'. Add export_presets.cfg to your project."
            ls -la
            exit 1
          fi

      - name: Run Godot export (HTML5)
        id: export
        run: |
          # choose the binary path
          BIN=$(find godot_bin -type f -executable | head -n1)
          if [ -z "$BIN" ]; then
            echo "Godot binary not found. Exiting."
            exit 1
          fi
          mkdir -p out_web
          echo "Exporting HTML5 using: $BIN"
          # This uses the export preset named "HTML5". Make sure it's present.
          "$BIN" --headless --export "HTML5" out_web || ( echo "Godot export failed"; exit 2 )
          ls -la out_web

      - name: Zip out_web
        run: |
          cd out_web
          zip -r ../web_build.zip . || true
          cd ..

      - name: Upload built zip to backend
        env:
          CALLBACK_URL: ${{ toJson(fromJSON(needs?)) || '' }}
          UPLOAD_SECRET: ${{ secrets.UPLOAD_SECRET }}
        run: |
          if [ -z "${{ secrets.UPLOAD_SECRET }}" ]; then
            echo "UPLOAD_SECRET must be set in repository secrets"
            exit 1
          fi
          # read callback URL from event payload
          CALLBACK=$(jq -r '.client_payload.callback_upload_url' "$GITHUB_EVENT_PATH")
          GAME_ID=$(jq -r '.client_payload.game_id' "$GITHUB_EVENT_PATH")
          if [ -z "$CALLBACK" ] || [ "$CALLBACK" = "null" ]; then
            echo "Callback upload URL not found in payload"
            exit 1
          fi
          echo "Uploading build for game: $GAME_ID to $CALLBACK"
          curl -v -X POST "$CALLBACK" \
            -H "X-Upload-Secret: ${{ secrets.UPLOAD_SECRET }}" \
            -F "game_id=$GAME_ID" \
            -F "file=@web_build.zip" \
            --fail
