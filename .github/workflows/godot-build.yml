name: Build Godot Web Game (robust)

on:
  workflow_dispatch:
    inputs:
      game_name:
        description: "Output build folder name (manual)"
        required: true
        default: "runner"
      template:
        description: "Game template folder inside /games (manual)"
        required: true
        default: "runner"

  repository_dispatch:
    types: [build_game]
    
jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Install system dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y wget unzip zip python3
      - name: Resolve GAME_NAME and TEMPLATE
        run: |
          python3 - <<'PY'
          import json, os
          evpath = os.environ.get("GITHUB_EVENT_PATH")
          ev = {}
          try:
              with open(evpath) as f:
                  ev = json.load(f)
          except Exception:
              pass

          payload = ev.get("client_payload", {}) or {}
          game = payload.get("game_name") or payload.get("game_id") or "runner"
          template = payload.get("template") or "runner"

          with open(os.environ["GITHUB_ENV"], "a") as f:
              f.write(f"GAME_NAME={game}\n")
              f.write(f"TEMPLATE={template}\n")

          print("GAME_NAME =", game)
          print("TEMPLATE  =", template)
          PY
      - name: Download Godot (headless)
        run: |
          wget https://github.com/godotengine/godot/releases/download/4.2.1-stable/Godot_v4.2.1-stable_linux.headless.64.zip
          unzip Godot_v4.2.1-stable_linux.headless.64.zip
          chmod +x Godot_v4.2.1-stable_linux.headless.64
          sudo mv Godot_v4.2.1-stable_linux.headless.64 /usr/local/bin/godot
          godot --version
      - name: Install Godot export templates
        run: |
          mkdir -p ~/.local/share/godot
          wget https://github.com/godotengine/godot/releases/download/4.2.1-stable/Godot_v4.2.1-stable_export_templates.tpz
          unzip Godot_v4.2.1-stable_export_templates.tpz -d ~/.local/share/godot
      - name: Prepare build workspace
        run: |
          rm -rf build_work out_builds || true
          mkdir -p build_work out_builds
          cp -r games/$TEMPLATE/. build_work/
      - name: Export Godot Web build
        run: |
          mkdir -p out_builds/$GAME_NAME
          godot --headless --path build_work --export "Web" out_builds/$GAME_NAME
      - name: Promote build
        run: |
          if [ -f out_builds/$GAME_NAME/index.html ]; then
            mkdir -p builds/$GAME_NAME
            cp -r out_builds/$GAME_NAME/* builds/$GAME_NAME/
          else
            echo "index.html not found"
            exit 1
          fi
      - name: Commit builds folder
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add builds
          git commit -m "Build game: $GAME_NAME" || echo "Nothing to commit"
          git push || true
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
           name: godot-build-${{ env.GAME_NAME }}
          path: builds/${{ env.GAME_NAME }}

          
        
