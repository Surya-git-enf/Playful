name: Godot HTML5 Build

on:
  repository_dispatch:
    types: [build_game]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip zip wget python3 curl

      - name: Set payload vars
        run: |
          echo "GAME_ID=${{ github.event.client_payload.game_id }}" >> $GITHUB_ENV
          echo "CALLBACK_URL=${{ github.event.client_payload.callback_upload_url }}" >> $GITHUB_ENV

      - name: Download Godot headless (4.2.1)
        run: |
          wget https://downloads.tuxfamily.org/godotengine/4.2.1/Godot_v4.2.1-stable_linux.headless.64.zip -O godot.zip
          unzip godot.zip
          chmod +x Godot_v4.2.1-stable_linux.headless.64
          sudo mv Godot_v4.2.1-stable_linux.headless.64 /usr/local/bin/godot
          godot --version

      - name: Install export templates
        run: |
          mkdir -p ~/.local/share/godot
          wget https://downloads.tuxfamily.org/godotengine/4.2.1/Godot_v4.2.1-stable_export_templates.tpz -O templates.tpz
          unzip templates.tpz -d ~/.local/share/godot
          ls ~/.local/share/godot

      - name: Prepare project
        run: |
          rm -rf build_work
          mkdir build_work
          cp -r games/runner/* build_work/

          python3 - <<EOF
import json, os
event = json.load(open(os.environ["GITHUB_EVENT_PATH"]))
cfg = event["client_payload"].get("config", {})
with open("build_work/game_config.json","w") as f:
    json.dump(cfg, f)
print("game_config.json written")
EOF

      - name: Export HTML5
        run: |
          mkdir -p out
          godot --headless --path build_work --export-release "Web" out
          ls out

      - name: Zip build
        run: |
          cd out
          zip -r ../${GAME_ID}.zip .
          cd ..
          ls -lh ${GAME_ID}.zip

      - name: Upload to backend
        env:
          UPLOAD_SECRET: ${{ secrets.UPLOAD_SECRET }}
        run: |
          curl -X POST "$CALLBACK_URL" \
            -H "X-Upload-Secret: $UPLOAD_SECRET" \
            -F "game_id=$GAME_ID" \
            -F "file=@${GAME_ID}.zip"
