name: Build Godot Web Game (offline)

on:
  workflow_dispatch:
    inputs:
      game_name:
        description: "Output build folder name"
        required: true
        default: "runner"
      template:
        description: "Game template folder inside /games"
        required: true
        default: "runner"

  repository_dispatch:
    types: [build_game]

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # 1️⃣ Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Install unzip
      - name: Install unzip
        run: |
          sudo apt-get update -y
          sudo apt-get install -y unzip zip

      # 3️⃣ Resolve input variables
      - name: Set build variables
        run: |
          if [ -n "${{ github.event.client_payload.game_id }}" ]; then
            echo "GAME_NAME=${{ github.event.client_payload.game_id }}" >> $GITHUB_ENV
          else
            echo "GAME_NAME=${{ github.event.inputs.game_name }}" >> $GITHUB_ENV
          fi

          if [ -n "${{ github.event.client_payload.template }}" ]; then
            echo "TEMPLATE=${{ github.event.client_payload.template }}" >> $GITHUB_ENV
          else
            echo "TEMPLATE=${{ github.event.inputs.template }}" >> $GITHUB_ENV
          fi

          echo "Resolved TEMPLATE=$TEMPLATE GAME_NAME=$GAME_NAME"

      # 4️⃣ Extract Godot headless from repo
      - name: Use Godot Headless from repo
        run: |
          unzip -q tools/Godot_v4.2.1-stable_linux.headless.64.zip -d tools/
          chmod +x tools/Godot_v4.2.1-stable_linux.headless.64
          sudo mv tools/Godot_v4.2.1-stable_linux.headless.64 /usr/local/bin/godot
          godot --version

      # 5️⃣ Prepare build workspace
      - name: Prepare build workspace
        run: |
          rm -rf build_work
          mkdir -p build_work
          cp -r "games/$TEMPLATE/." build_work/
          echo "Listing build_work files:"
          ls -R build_work

      # 6️⃣ Validate template project
      - name: Validate template
        run: |
          if [ ! -f build_work/project.godot ]; then
            echo "ERROR: project.godot missing in template"
            exit 1
          fi
          if [ ! -f build_work/export_presets.cfg ]; then
            echo "ERROR: export_presets.cfg missing in template"
            exit 1
          fi
          if [ ! -f build_work/main.tscn ]; then
            echo "ERROR: main.tscn missing in template"
            exit 1
          fi

      # 7️⃣ Run Godot export
      - name: Export Web build
        run: |
          set -o pipefail
          mkdir -p out_builds/${GAME_NAME}
          godot --headless --path build_work --export "Web" out_builds/${GAME_NAME} 2>&1 | tee godot_export_log.txt || export_code=$?; echo "EXPORT_EXIT=$export_code"; if [ "${export_code:-0}" != "0" ]; then echo "=== Godot Export Log Start ==="; head -n 200 godot_export_log.txt; echo "=== Godot Export Log End ==="; exit $export_code; fi
          echo "Listing out_builds/${GAME_NAME}:"
          ls -la out_builds/${GAME_NAME}

      # 8️⃣ Package output
      - name: Zip output
        run: |
          if [ -d out_builds/${GAME_NAME} ]; then
            cd out_builds/${GAME_NAME}
            zip -r ../../${GAME_NAME}.zip . || true
            cd ../../
            ls -lh ${GAME_NAME}.zip
          else
            echo "No build output found, export likely failed"
            exit 1
          fi

      # 9️⃣ Optional: debug builds folder
      - name: List builds folder
        run: |
          echo "Listing builds folder in repo:"
          ls -R builds || true
